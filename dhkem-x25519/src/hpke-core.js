var p=class extends Error{constructor(e){let t;e instanceof Error?t=e.message:typeof e=="string"?t=e:t="",super(t),this.name=this.constructor.name}},f=class extends p{},_e=class extends p{},d=class extends p{},h=class extends p{},G=class extends p{},R=class extends p{},F=class extends p{},$=class extends p{},X=class extends p{},W=class extends p{},k=class extends p{},b=class extends p{};var it={},ge=nt(globalThis,it);function nt(i,e){return new Proxy(i,{get(t,r,n){return r in e?e[r]:i[r]},set(t,r,n){return r in e&&delete e[r],i[r]=n,!0},deleteProperty(t,r){let n=!1;return r in e&&(delete e[r],n=!0),r in i&&(delete i[r],n=!0),n},ownKeys(t){let r=Reflect.ownKeys(i),n=Reflect.ownKeys(e),a=new Set(n);return[...r.filter(s=>!a.has(s)),...n]},defineProperty(t,r,n){return r in e&&delete e[r],Reflect.defineProperty(i,r,n),!0},getOwnPropertyDescriptor(t,r){return r in e?Reflect.getOwnPropertyDescriptor(e,r):Reflect.getOwnPropertyDescriptor(i,r)},has(t,r){return r in e||r in i}})}async function at(){if(ge!==void 0&&globalThis.crypto!==void 0)return globalThis.crypto.subtle;try{let{webcrypto:i}=await import("crypto");return i.subtle}catch(i){throw new b(i)}}var y=class{constructor(){Object.defineProperty(this,"_api",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}async _setup(){this._api===void 0&&(this._api=await at())}};var P={Base:0,Psk:1,Auth:2,AuthPsk:3},c={NotAssigned:0,DhkemP256HkdfSha256:16,DhkemP384HkdfSha384:17,DhkemP521HkdfSha512:18,DhkemSecp256k1HkdfSha256:19,DhkemX25519HkdfSha256:32,DhkemX448HkdfSha512:33,HybridkemX25519Kyber768:48,MlKem512:64,MlKem768:65,MlKem1024:66,XWing:25722},L={HkdfSha256:1,HkdfSha384:2,HkdfSha512:3,Sha3256:4,Sha3384:5,Sha3512:6,Shake128:16,Shake256:17,TurboShake128:18,TurboShake256:19},K={Aes128Gcm:1,Aes256Gcm:2,Chacha20Poly1305:3,ExportOnly:65535};var o=new Uint8Array(0),V=BigInt(0),O=BigInt(1),ve=BigInt(2),Ge=BigInt(7),Pe=BigInt(32),Re=BigInt(256),Fe=BigInt(113);var te=new Uint8Array([75,69,77,0,0]);var E=i=>typeof i=="object"&&i!==null&&typeof i.privateKey=="object"&&typeof i.publicKey=="object";function x(i,e){if(e<=0)throw new Error("i2Osp: too small size");if(i>=256**e)throw new Error("i2Osp: too large integer");let t=new Uint8Array(e);for(let r=0;r<e&&i;r++)t[e-(r+1)]=i%256,i=i>>8;return t}function j(i,e){let t=new Uint8Array(i.length+e.length);return t.set(i,0),t.set(e,i.length),t}function H(i){let e=i.replace(/-/g,"+").replace(/_/g,"/"),t=atob(e),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function ke(i,e){if(i.byteLength!==e.byteLength)throw new Error("xor: different length inputs");let t=new Uint8Array(i.byteLength);for(let r=0;r<i.byteLength;r++)t[r]=i[r]^e[r];return t}var st=new Uint8Array([101,97,101,95,112,114,107]),ot=new Uint8Array([115,104,97,114,101,100,95,115,101,99,114,101,116]);function ut(i,e,t){let r=new Uint8Array(i.length+e.length+t.length);return r.set(i,0),r.set(e,i.length),r.set(t,i.length+e.length),r}var _=class{constructor(e,t,r){Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_prim",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_kdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e,this._prim=t,this._kdf=r;let n=new Uint8Array(te);n.set(x(this.id,2),3),this._kdf.init(n)}async serializePublicKey(e){return await this._prim.serializePublicKey(e)}async deserializePublicKey(e){return await this._prim.deserializePublicKey(e)}async serializePrivateKey(e){return await this._prim.serializePrivateKey(e)}async deserializePrivateKey(e){return await this._prim.deserializePrivateKey(e)}async importKey(e,t,r=!0){return await this._prim.importKey(e,t,r)}async generateKeyPair(){return await this._prim.generateKeyPair()}async deriveKeyPair(e){if(e.byteLength>8192)throw new f("Too long ikm");return await this._prim.deriveKeyPair(e)}async encap(e){let t;e.ekm===void 0?t=await this.generateKeyPair():E(e.ekm)?t=e.ekm:t=await this.deriveKeyPair(e.ekm);let r=await this._prim.serializePublicKey(t.publicKey),n=await this._prim.serializePublicKey(e.recipientPublicKey);try{let a;if(e.senderKey===void 0)a=new Uint8Array(await this._prim.dh(t.privateKey,e.recipientPublicKey));else{let l=E(e.senderKey)?e.senderKey.privateKey:e.senderKey,g=new Uint8Array(await this._prim.dh(t.privateKey,e.recipientPublicKey)),v=new Uint8Array(await this._prim.dh(l,e.recipientPublicKey));a=j(g,v)}let s;if(e.senderKey===void 0)s=j(new Uint8Array(r),new Uint8Array(n));else{let l=E(e.senderKey)?e.senderKey.publicKey:await this._prim.derivePublicKey(e.senderKey),g=await this._prim.serializePublicKey(l);s=ut(new Uint8Array(r),new Uint8Array(n),new Uint8Array(g))}let u=await this._generateSharedSecret(a,s);return{enc:r,sharedSecret:u}}catch(a){throw new G(a)}}async decap(e){let t=await this._prim.deserializePublicKey(e.enc),r=E(e.recipientKey)?e.recipientKey.privateKey:e.recipientKey,n=E(e.recipientKey)?e.recipientKey.publicKey:await this._prim.derivePublicKey(e.recipientKey),a=await this._prim.serializePublicKey(n);try{let s;if(e.senderPublicKey===void 0)s=new Uint8Array(await this._prim.dh(r,t));else{let l=new Uint8Array(await this._prim.dh(r,t)),g=new Uint8Array(await this._prim.dh(r,e.senderPublicKey));s=j(l,g)}let u;if(e.senderPublicKey===void 0)u=j(new Uint8Array(e.enc),new Uint8Array(a));else{let l=await this._prim.serializePublicKey(e.senderPublicKey);u=new Uint8Array(e.enc.byteLength+a.byteLength+l.byteLength),u.set(new Uint8Array(e.enc),0),u.set(new Uint8Array(a),e.enc.byteLength),u.set(new Uint8Array(l),e.enc.byteLength+a.byteLength)}return await this._generateSharedSecret(s,u)}catch(s){throw new R(s)}}async _generateSharedSecret(e,t){let r=this._kdf.buildLabeledIkm(st,e),n=this._kdf.buildLabeledInfo(ot,t,this.secretSize);return await this._kdf.extractAndExpand(o.buffer,r.buffer,n.buffer,this.secretSize)}};var w=["deriveBits"],I=new Uint8Array([100,107,112,95,112,114,107]),T=new Uint8Array([115,107]);var re=class{constructor(e){Object.defineProperty(this,"_num",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._num=new Uint8Array(e)}val(){return this._num}reset(){this._num.fill(0)}set(e){if(e.length!==this._num.length)throw new Error("Bignum.set: invalid argument");this._num.set(e)}isZero(){for(let e=0;e<this._num.length;e++)if(this._num[e]!==0)return!1;return!0}lessThan(e){if(e.length!==this._num.length)throw new Error("Bignum.lessThan: invalid argument");for(let t=0;t<this._num.length;t++){if(this._num[t]<e[t])return!0;if(this._num[t]>e[t])return!1}return!1}};var ct=new Uint8Array([99,97,110,100,105,100,97,116,101]),lt=new Uint8Array([255,255,255,255,0,0,0,0,255,255,255,255,255,255,255,255,188,230,250,173,167,23,158,132,243,185,202,194,252,99,37,81]),ht=new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,199,99,77,129,244,55,45,223,88,26,13,178,72,176,167,122,236,236,25,106,204,197,41,115]),ft=new Uint8Array([1,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,250,81,134,135,131,191,47,150,107,127,204,1,72,247,9,165,208,59,181,201,184,137,156,71,174,187,111,183,30,145,56,100,9]),dt=new Uint8Array([48,65,2,1,0,48,19,6,7,42,134,72,206,61,2,1,6,8,42,134,72,206,61,3,1,7,4,39,48,37,2,1,1,4,32]),bt=new Uint8Array([48,78,2,1,0,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,34,4,55,48,53,2,1,1,4,48]),pt=new Uint8Array([48,96,2,1,0,48,16,6,7,42,134,72,206,61,2,1,6,5,43,129,4,0,35,4,73,48,71,2,1,1,4,66]),B=class extends y{constructor(e,t){switch(super(),Object.defineProperty(this,"_hkdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_alg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nPk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nSk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nDh",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_bitmask",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_pkcs8AlgId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._hkdf=t,e){case c.DhkemP256HkdfSha256:this._alg={name:"ECDH",namedCurve:"P-256"},this._nPk=65,this._nSk=32,this._nDh=32,this._order=lt,this._bitmask=255,this._pkcs8AlgId=dt;break;case c.DhkemP384HkdfSha384:this._alg={name:"ECDH",namedCurve:"P-384"},this._nPk=97,this._nSk=48,this._nDh=48,this._order=ht,this._bitmask=255,this._pkcs8AlgId=bt;break;default:this._alg={name:"ECDH",namedCurve:"P-521"},this._nPk=133,this._nSk=66,this._nDh=66,this._order=ft,this._bitmask=1,this._pkcs8AlgId=pt;break}}async serializePublicKey(e){await this._setup();try{return await this._api.exportKey("raw",e)}catch(t){throw new d(t)}}async deserializePublicKey(e){await this._setup();try{return await this._importRawKey(e,!0)}catch(t){throw new h(t)}}async serializePrivateKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);if(!("d"in t))throw new Error("Not private key");return H(t.d).buffer}catch(t){throw new d(t)}}async deserializePrivateKey(e){await this._setup();try{return await this._importRawKey(e,!1)}catch(t){throw new h(t)}}async importKey(e,t,r){await this._setup();try{if(e==="raw")return await this._importRawKey(t,r);if(t instanceof ArrayBuffer)throw new Error("Invalid jwk key format");return await this._importJWK(t,r)}catch(n){throw new h(n)}}async generateKeyPair(){await this._setup();try{return await this._api.generateKey(this._alg,!0,w)}catch(e){throw new b(e)}}async deriveKeyPair(e){await this._setup();try{let t=await this._hkdf.labeledExtract(o.buffer,I,new Uint8Array(e)),r=new re(this._nSk);for(let a=0;r.isZero()||!r.lessThan(this._order);a++){if(a>255)throw new Error("Faild to derive a key pair");let s=new Uint8Array(await this._hkdf.labeledExpand(t,ct,x(a,1),this._nSk));s[0]=s[0]&this._bitmask,r.set(s)}let n=await this._deserializePkcs8Key(r.val());return r.reset(),{privateKey:n,publicKey:await this.derivePublicKey(n)}}catch(t){throw new k(t)}}async derivePublicKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);return delete t.d,delete t.key_ops,await this._api.importKey("jwk",t,this._alg,!0,[])}catch(t){throw new h(t)}}async dh(e,t){try{return await this._setup(),await this._api.deriveBits({name:"ECDH",public:t},e,this._nDh*8)}catch(r){throw new d(r)}}async _importRawKey(e,t){if(t&&e.byteLength!==this._nPk)throw new Error("Invalid public key for the ciphersuite");if(!t&&e.byteLength!==this._nSk)throw new Error("Invalid private key for the ciphersuite");return t?await this._api.importKey("raw",e,this._alg,!0,[]):await this._deserializePkcs8Key(new Uint8Array(e))}async _importJWK(e,t){if(typeof e.crv>"u"||e.crv!==this._alg.namedCurve)throw new Error(`Invalid crv: ${e.crv}`);if(t){if(typeof e.d<"u")throw new Error("Invalid key: `d` should not be set");return await this._api.importKey("jwk",e,this._alg,!0,[])}if(typeof e.d>"u")throw new Error("Invalid key: `d` not found");return await this._api.importKey("jwk",e,this._alg,!0,w)}async _deserializePkcs8Key(e){let t=new Uint8Array(this._pkcs8AlgId.length+e.length);return t.set(this._pkcs8AlgId,0),t.set(e,this._pkcs8AlgId.length),await this._api.importKey("pkcs8",t,this._alg,!0,w)}};var $e=new Uint8Array([72,80,75,69,45,118,49]),q=class extends y{constructor(){super(),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:L.HkdfSha256}),Object.defineProperty(this,"hashSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"_suiteId",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"algHash",{enumerable:!0,configurable:!0,writable:!0,value:{name:"HMAC",hash:"SHA-256",length:256}})}init(e){this._suiteId=e}buildLabeledIkm(e,t){this._checkInit();let r=new Uint8Array(7+this._suiteId.byteLength+e.byteLength+t.byteLength);return r.set($e,0),r.set(this._suiteId,7),r.set(e,7+this._suiteId.byteLength),r.set(t,7+this._suiteId.byteLength+e.byteLength),r}buildLabeledInfo(e,t,r){this._checkInit();let n=new Uint8Array(9+this._suiteId.byteLength+e.byteLength+t.byteLength);return n.set(new Uint8Array([0,r]),0),n.set($e,2),n.set(this._suiteId,9),n.set(e,9+this._suiteId.byteLength),n.set(t,9+this._suiteId.byteLength+e.byteLength),n}async extract(e,t){if(await this._setup(),e.byteLength===0&&(e=new ArrayBuffer(this.hashSize)),e.byteLength!==this.hashSize)throw new f("The salt length must be the same as the hashSize");let r=await this._api.importKey("raw",e,this.algHash,!1,["sign"]);return await this._api.sign("HMAC",r,t)}async expand(e,t,r){await this._setup();let n=await this._api.importKey("raw",e,this.algHash,!1,["sign"]),a=new ArrayBuffer(r),s=new Uint8Array(a),u=o,l=new Uint8Array(t),g=new Uint8Array(1);if(r>255*this.hashSize)throw new Error("Entropy limit reached");let v=new Uint8Array(this.hashSize+l.length+1);for(let ee=1,m=0;m<s.length;ee++)g[0]=ee,v.set(u,0),v.set(l,u.length),v.set(g,u.length+l.length),u=new Uint8Array(await this._api.sign("HMAC",n,v.slice(0,u.length+l.length+1))),s.length-m>=u.length?(s.set(u,m),m+=u.length):(s.set(u.slice(0,s.length-m),m),m+=s.length-m);return a}async extractAndExpand(e,t,r,n){await this._setup();let a=await this._api.importKey("raw",t,"HKDF",!1,["deriveBits"]);return await this._api.deriveBits({name:"HKDF",hash:this.algHash.hash,salt:e,info:r},a,n*8)}async labeledExtract(e,t,r){return await this.extract(e,this.buildLabeledIkm(t,r).buffer)}async labeledExpand(e,t,r,n){return await this.expand(e,this.buildLabeledInfo(t,r,n).buffer,n)}_checkInit(){if(this._suiteId===o)throw new Error("Not initialized. Call init()")}},A=class extends q{constructor(){super(...arguments),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:L.HkdfSha256}),Object.defineProperty(this,"hashSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"algHash",{enumerable:!0,configurable:!0,writable:!0,value:{name:"HMAC",hash:"SHA-256",length:256}})}},z=class extends q{constructor(){super(...arguments),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:L.HkdfSha384}),Object.defineProperty(this,"hashSize",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(this,"algHash",{enumerable:!0,configurable:!0,writable:!0,value:{name:"HMAC",hash:"SHA-384",length:384}})}},S=class extends q{constructor(){super(...arguments),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:L.HkdfSha512}),Object.defineProperty(this,"hashSize",{enumerable:!0,configurable:!0,writable:!0,value:64}),Object.defineProperty(this,"algHash",{enumerable:!0,configurable:!0,writable:!0,value:{name:"HMAC",hash:"SHA-512",length:512}})}};var Ke=["encrypt","decrypt"];function xt(i){return i instanceof Uint8Array||ArrayBuffer.isView(i)&&i.constructor.name==="Uint8Array"}function ie(i,e=""){if(!Number.isSafeInteger(i)||i<0){let t=e&&`"${e}" `;throw new Error(`${t}expected integer >0, got ${i}`)}}function D(i,e,t=""){let r=xt(i),n=i?.length,a=e!==void 0;if(!r||a&&n!==e){let s=t&&`"${t}" `,u=a?` of length ${e}`:"",l=r?`length=${n}`:`type=${typeof i}`;throw new Error(s+"expected Uint8Array"+u+", got "+l)}return i}function Y(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function J(...i){for(let e=0;e<i.length;e++)i[e].fill(0)}var mt=new Uint32Array([287454020]),_t=new Uint8Array(mt.buffer),Ir=_t[0]===68;function Xe(i){if(typeof i!="function"||typeof i.create!="function")throw new Error("Hash must wrapped by utils.createHasher");ie(i.outputLen),ie(i.blockLen)}var ne=class{constructor(e,t){if(Object.defineProperty(this,"oHash",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"iHash",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockLen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputLen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"finished",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"destroyed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Xe(e),D(t,void 0,"key"),this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,n=new Uint8Array(r);n.set(t.length>r?e.create().update(t).digest():t);for(let a=0;a<n.length;a++)n[a]^=54;this.iHash.update(n),this.oHash=e.create();for(let a=0;a<n.length;a++)n[a]^=106;this.oHash.update(n),J(n)}update(e){return Y(this),this.iHash.update(e),this}digestInto(e){Y(this),D(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});let{oHash:t,iHash:r,finished:n,destroyed:a,blockLen:s,outputLen:u}=this;return e=e,e.finished=n,e.destroyed=a,e.blockLen=s,e.outputLen=u,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},We=(i,e,t)=>new ne(i,e).update(t).digest();We.create=(i,e)=>new ne(i,e);var ae=BigInt(2**32-1);function vt(i,e=!1){return e?{h:Number(i&ae),l:Number(i>>Pe&ae)}:{h:Number(i>>Pe&ae)|0,l:Number(i&ae)|0}}function Ae(i,e=!1){let t=i.length,r=new Uint32Array(t),n=new Uint32Array(t);for(let a=0;a<t;a++){let{h:s,l:u}=vt(i[a],e);[r[a],n[a]]=[s,u]}return[r,n]}var At=[],St=[],Ve=[];for(let i=0,e=O,t=1,r=0;i<24;i++){[t,r]=[r,(2*t+3*r)%5],At.push(2*(5*r+t)),St.push((i+1)*(i+2)/2%64);let n=V;for(let a=0;a<7;a++)e=(e<<O^(e>>Ge)*Fe)%Re,e&ve&&(n^=O<<(O<<BigInt(a))-O);Ve.push(n)}var qe=Ae(Ve,!0),_i=qe[0],gi=qe[1];var Ee=class extends y{constructor(e){super(),Object.defineProperty(this,"_rawKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_key",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._rawKey=e}async seal(e,t,r){await this._setupKey();let n={name:"AES-GCM",iv:e,additionalData:r};return await this._api.encrypt(n,this._key,t)}async open(e,t,r){await this._setupKey();let n={name:"AES-GCM",iv:e,additionalData:r};return await this._api.decrypt(n,this._key,t)}async _setupKey(){if(this._key!==void 0)return;await this._setup();let e=await this._importKey(this._rawKey);new Uint8Array(this._rawKey).fill(0),this._key=e}async _importKey(e){return await this._api.importKey("raw",e,{name:"AES-GCM"},!0,Ke)}},se=class{constructor(){Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:K.Aes128Gcm}),Object.defineProperty(this,"keySize",{enumerable:!0,configurable:!0,writable:!0,value:16}),Object.defineProperty(this,"nonceSize",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(this,"tagSize",{enumerable:!0,configurable:!0,writable:!0,value:16})}createEncryptionContext(e){return new Ee(e)}},Ie=class extends se{constructor(){super(...arguments),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:K.Aes256Gcm}),Object.defineProperty(this,"keySize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"nonceSize",{enumerable:!0,configurable:!0,writable:!0,value:12}),Object.defineProperty(this,"tagSize",{enumerable:!0,configurable:!0,writable:!0,value:16})}};var Le=class{constructor(){Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:K.ExportOnly}),Object.defineProperty(this,"keySize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"nonceSize",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"tagSize",{enumerable:!0,configurable:!0,writable:!0,value:0})}createEncryptionContext(e){throw new b("Export only")}};function Oe(){return new Promise((i,e)=>{e(new b("Not supported"))})}var It=new Uint8Array([115,101,99]),N=class{constructor(e,t,r){Object.defineProperty(this,"_api",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exporterSecret",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_kdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._api=e,this._kdf=t,this.exporterSecret=r}async seal(e,t){return await Oe()}async open(e,t){return await Oe()}async export(e,t){if(e.byteLength>8192)throw new f("Too long exporter context");try{return await this._kdf.labeledExpand(this.exporterSecret,It,new Uint8Array(e),t)}catch(r){throw new F(r)}}},oe=class extends N{},ue=class extends N{constructor(e,t,r,n){super(e,t,r),Object.defineProperty(this,"enc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.enc=n}};var C=class extends N{constructor(e,t,r){if(super(e,t,r.exporterSecret),Object.defineProperty(this,"_aead",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nT",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_ctx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),r.key===void 0||r.baseNonce===void 0||r.seq===void 0)throw new Error("Required parameters are missing");this._aead=r.aead,this._nK=this._aead.keySize,this._nN=this._aead.nonceSize,this._nT=this._aead.tagSize;let n=this._aead.createEncryptionContext(r.key);this._ctx={key:n,baseNonce:r.baseNonce,seq:r.seq}}computeNonce(e){let t=x(e.seq,e.baseNonce.byteLength);return ke(e.baseNonce,t).buffer}incrementSeq(e){if(e.seq>Number.MAX_SAFE_INTEGER)throw new W("Message limit reached");e.seq+=1}};var Lt=function(i,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!r:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(i):r?r.value:e.get(i)},Ot=function(i,e,t,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!n:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(i,t):n?n.value=t:e.set(i,t),t},ce,M=class{constructor(){ce.set(this,Promise.resolve())}async lock(){let e,t=new Promise(n=>{e=n}),r=Lt(this,ce,"f");return Ot(this,ce,t,"f"),await r,e}};ce=new WeakMap;var Je=function(i,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!r:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(i):r?r.value:e.get(i)},jt=function(i,e,t,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!n:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(i,t):n?n.value=t:e.set(i,t),t},Z,le=class extends C{constructor(){super(...arguments),Z.set(this,void 0)}async open(e,t=o.buffer){jt(this,Z,Je(this,Z,"f")??new M,"f");let r=await Je(this,Z,"f").lock(),n;try{n=await this._ctx.key.open(this.computeNonce(this._ctx),e,t)}catch(a){throw new X(a)}finally{r()}return this.incrementSeq(this._ctx),n}};Z=new WeakMap;var Ze=function(i,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?i!==e||!r:!e.has(i))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(i):r?r.value:e.get(i)},Ht=function(i,e,t,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?i!==e||!n:!e.has(i))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(i,t):n?n.value=t:e.set(i,t),t},Q,he=class extends C{constructor(e,t,r,n){super(e,t,r),Object.defineProperty(this,"enc",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Q.set(this,void 0),this.enc=n}async seal(e,t=o.buffer){Ht(this,Q,Ze(this,Q,"f")??new M,"f");let r=await Ze(this,Q,"f").lock(),n;try{n=await this._ctx.key.seal(this.computeNonce(this._ctx),e,t)}catch(a){throw new $(a)}finally{r()}return this.incrementSeq(this._ctx),n}};Q=new WeakMap;var Ut=new Uint8Array([98,97,115,101,95,110,111,110,99,101]),Bt=new Uint8Array([101,120,112]),zt=new Uint8Array([105,110,102,111,95,104,97,115,104]),Tt=new Uint8Array([107,101,121]),Dt=new Uint8Array([112,115,107,95,105,100,95,104,97,115,104]),Nt=new Uint8Array([115,101,99,114,101,116]),Ct=new Uint8Array([72,80,75,69,0,0,0,0,0,0]),fe=class extends y{constructor(e){if(super(),Object.defineProperty(this,"_kem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_kdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_aead",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_suiteId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof e.kem=="number")throw new f("KemId cannot be used");if(this._kem=e.kem,typeof e.kdf=="number")throw new f("KdfId cannot be used");if(this._kdf=e.kdf,typeof e.aead=="number")throw new f("AeadId cannot be used");this._aead=e.aead,this._suiteId=new Uint8Array(Ct),this._suiteId.set(x(this._kem.id,2),4),this._suiteId.set(x(this._kdf.id,2),6),this._suiteId.set(x(this._aead.id,2),8),this._kdf.init(this._suiteId)}get kem(){return this._kem}get kdf(){return this._kdf}get aead(){return this._aead}async createSenderContext(e){this._validateInputLength(e),await this._setup();let t=await this._kem.encap(e),r;return e.psk!==void 0?r=e.senderKey!==void 0?P.AuthPsk:P.Psk:r=e.senderKey!==void 0?P.Auth:P.Base,await this._keyScheduleS(r,t.sharedSecret,t.enc,e)}async createRecipientContext(e){this._validateInputLength(e),await this._setup();let t=await this._kem.decap(e),r;return e.psk!==void 0?r=e.senderPublicKey!==void 0?P.AuthPsk:P.Psk:r=e.senderPublicKey!==void 0?P.Auth:P.Base,await this._keyScheduleR(r,t,e)}async seal(e,t,r=o.buffer){let n=await this.createSenderContext(e);return{ct:await n.seal(t,r),enc:n.enc}}async open(e,t,r=o.buffer){return await(await this.createRecipientContext(e)).open(t,r)}async _keySchedule(e,t,r){let n=r.psk===void 0?o:new Uint8Array(r.psk.id),a=await this._kdf.labeledExtract(o.buffer,Dt,n),s=r.info===void 0?o:new Uint8Array(r.info),u=await this._kdf.labeledExtract(o.buffer,zt,s),l=new Uint8Array(1+a.byteLength+u.byteLength);l.set(new Uint8Array([e]),0),l.set(new Uint8Array(a),1),l.set(new Uint8Array(u),1+a.byteLength);let g=r.psk===void 0?o:new Uint8Array(r.psk.key),v=this._kdf.buildLabeledIkm(Nt,g).buffer,ee=this._kdf.buildLabeledInfo(Bt,l,this._kdf.hashSize).buffer,m=await this._kdf.extractAndExpand(t,v,ee,this._kdf.hashSize);if(this._aead.id===K.ExportOnly)return{aead:this._aead,exporterSecret:m};let Qe=this._kdf.buildLabeledInfo(Tt,l,this._aead.keySize).buffer,et=await this._kdf.extractAndExpand(t,v,Qe,this._aead.keySize),tt=this._kdf.buildLabeledInfo(Ut,l,this._aead.nonceSize).buffer,rt=await this._kdf.extractAndExpand(t,v,tt,this._aead.nonceSize);return{aead:this._aead,exporterSecret:m,key:et,baseNonce:new Uint8Array(rt),seq:0}}async _keyScheduleS(e,t,r,n){let a=await this._keySchedule(e,t,n);return a.key===void 0?new ue(this._api,this._kdf,a.exporterSecret,r):new he(this._api,this._kdf,a,r)}async _keyScheduleR(e,t,r){let n=await this._keySchedule(e,t,r);return n.key===void 0?new oe(this._api,this._kdf,n.exporterSecret):new le(this._api,this._kdf,n)}_validateInputLength(e){if(e.info!==void 0&&e.info.byteLength>65536)throw new f("Too long info");if(e.psk!==void 0){if(e.psk.key.byteLength<32)throw new f(`PSK must have at least ${32} bytes`);if(e.psk.key.byteLength>8192)throw new f("Too long psk.key");if(e.psk.id.byteLength>8192)throw new f("Too long psk.id")}}};var de=class extends _{constructor(){let e=new A,t=new B(c.DhkemP256HkdfSha256,e);super(c.DhkemP256HkdfSha256,t,e),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:c.DhkemP256HkdfSha256}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:65}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:65}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:32})}},be=class extends _{constructor(){let e=new z,t=new B(c.DhkemP384HkdfSha384,e);super(c.DhkemP384HkdfSha384,t,e),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:c.DhkemP384HkdfSha384}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:48}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:97}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:97}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:48})}},pe=class extends _{constructor(){let e=new S,t=new B(c.DhkemP521HkdfSha512,e);super(c.DhkemP521HkdfSha512,t,e),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:c.DhkemP521HkdfSha512}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:64}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:133}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:133}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:64})}};var je=class extends fe{},He=class extends de{},Ue=class extends be{},Be=class extends pe{},ze=class extends A{},Te=class extends z{},De=class extends S{};var ye="X25519",Mt=new Uint8Array([48,46,2,1,0,48,5,6,3,43,101,110,4,34,4,32]),we=class extends y{constructor(e){super(),Object.defineProperty(this,"_hkdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_alg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nPk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nSk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nDh",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_pkcs8AlgId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._alg={name:ye},this._hkdf=e,this._nPk=32,this._nSk=32,this._nDh=32,this._pkcs8AlgId=Mt}async serializePublicKey(e){await this._setup();try{return await this._api.exportKey("raw",e)}catch(t){throw new d(t)}}async deserializePublicKey(e){await this._setup();try{return await this._importRawKey(e,!0)}catch(t){throw new h(t)}}async serializePrivateKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);if(!("d"in t))throw new Error("Not private key");return H(t.d).buffer}catch(t){throw new d(t)}}async deserializePrivateKey(e){await this._setup();try{return await this._importRawKey(e,!1)}catch(t){throw new h(t)}}async importKey(e,t,r){await this._setup();try{if(e==="raw")return await this._importRawKey(t,r);if(t instanceof ArrayBuffer)throw new Error("Invalid jwk key format");return await this._importJWK(t,r)}catch(n){throw new h(n)}}async generateKeyPair(){await this._setup();try{return await this._api.generateKey(ye,!0,w)}catch(e){throw new b(e)}}async deriveKeyPair(e){await this._setup();try{let t=await this._hkdf.labeledExtract(o.buffer,I,new Uint8Array(e)),r=await this._hkdf.labeledExpand(t,T,o,this._nSk),n=new Uint8Array(r),a=await this._deserializePkcs8Key(n);return n.fill(0),{privateKey:a,publicKey:await this.derivePublicKey(a)}}catch(t){throw new k(t)}}async derivePublicKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);return delete t.d,delete t.key_ops,await this._api.importKey("jwk",t,this._alg,!0,[])}catch(t){throw new h(t)}}async dh(e,t){await this._setup();try{return await this._api.deriveBits({name:ye,public:t},e,this._nDh*8)}catch(r){throw new d(r)}}async _importRawKey(e,t){if(t&&e.byteLength!==this._nPk)throw new Error("Invalid public key for the ciphersuite");if(!t&&e.byteLength!==this._nSk)throw new Error("Invalid private key for the ciphersuite");return t?await this._api.importKey("raw",e,this._alg,!0,[]):await this._deserializePkcs8Key(new Uint8Array(e))}async _importJWK(e,t){if(typeof e.kty>"u"||e.kty!=="OKP")throw new Error(`Invalid kty: ${e.crv}`);if(typeof e.crv>"u"||e.crv!==ye)throw new Error(`Invalid crv: ${e.crv}`);if(t){if(typeof e.d<"u")throw new Error("Invalid key: `d` should not be set");return await this._api.importKey("jwk",e,this._alg,!0,[])}if(typeof e.d>"u")throw new Error("Invalid key: `d` not found");return await this._api.importKey("jwk",e,this._alg,!0,w)}async _deserializePkcs8Key(e){let t=new Uint8Array(this._pkcs8AlgId.length+e.length);return t.set(this._pkcs8AlgId,0),t.set(e,this._pkcs8AlgId.length),await this._api.importKey("pkcs8",t,this._alg,!0,w)}};var Ne=class extends _{constructor(){let e=new A;super(c.DhkemX25519HkdfSha256,new we(e),e),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:c.DhkemX25519HkdfSha256}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:32}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:32})}};var xe="X448",Gt=new Uint8Array([48,70,2,1,0,48,5,6,3,43,101,111,4,58,4,56]),me=class extends y{constructor(e){super(),Object.defineProperty(this,"_hkdf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_alg",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nPk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nSk",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_nDh",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_pkcs8AlgId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._alg={name:xe},this._hkdf=e,this._nPk=56,this._nSk=56,this._nDh=56,this._pkcs8AlgId=Gt}async serializePublicKey(e){await this._setup();try{return await this._api.exportKey("raw",e)}catch(t){throw new d(t)}}async deserializePublicKey(e){await this._setup();try{return await this._importRawKey(e,!0)}catch(t){throw new h(t)}}async serializePrivateKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);if(!("d"in t))throw new Error("Not private key");return H(t.d).buffer}catch(t){throw new d(t)}}async deserializePrivateKey(e){await this._setup();try{return await this._importRawKey(e,!1)}catch(t){throw new h(t)}}async importKey(e,t,r){await this._setup();try{if(e==="raw")return await this._importRawKey(t,r);if(t instanceof ArrayBuffer)throw new Error("Invalid jwk key format");return await this._importJWK(t,r)}catch(n){throw new h(n)}}async generateKeyPair(){await this._setup();try{return await this._api.generateKey(xe,!0,w)}catch(e){throw new b(e)}}async deriveKeyPair(e){await this._setup();try{let t=await this._hkdf.labeledExtract(o.buffer,I,new Uint8Array(e)),r=await this._hkdf.labeledExpand(t,T,o,this._nSk),n=new Uint8Array(r),a=await this._deserializePkcs8Key(n);return n.fill(0),{privateKey:a,publicKey:await this.derivePublicKey(a)}}catch(t){throw new k(t)}}async derivePublicKey(e){await this._setup();try{let t=await this._api.exportKey("jwk",e);return delete t.d,delete t.key_ops,await this._api.importKey("jwk",t,this._alg,!0,[])}catch(t){throw new h(t)}}async dh(e,t){await this._setup();try{return await this._api.deriveBits({name:xe,public:t},e,this._nDh*8)}catch(r){throw new d(r)}}async _importRawKey(e,t){if(t&&e.byteLength!==this._nPk)throw new Error("Invalid public key for the ciphersuite");if(!t&&e.byteLength!==this._nSk)throw new Error("Invalid private key for the ciphersuite");return t?await this._api.importKey("raw",e,this._alg,!0,[]):await this._deserializePkcs8Key(new Uint8Array(e))}async _importJWK(e,t){if(typeof e.kty>"u"||e.kty!=="OKP")throw new Error(`Invalid kty: ${e.crv}`);if(typeof e.crv>"u"||e.crv!==xe)throw new Error(`Invalid crv: ${e.crv}`);if(t){if(typeof e.d<"u")throw new Error("Invalid key: `d` should not be set");return await this._api.importKey("jwk",e,this._alg,!0,[])}if(typeof e.d>"u")throw new Error("Invalid key: `d` not found");return await this._api.importKey("jwk",e,this._alg,!0,w)}async _deserializePkcs8Key(e){let t=new Uint8Array(this._pkcs8AlgId.length+e.length);return t.set(this._pkcs8AlgId,0),t.set(e,this._pkcs8AlgId.length),await this._api.importKey("pkcs8",t,this._alg,!0,w)}};var Ce=class extends _{constructor(){let e=new S;super(c.DhkemX448HkdfSha512,new me(e),e),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:c.DhkemX448HkdfSha512}),Object.defineProperty(this,"secretSize",{enumerable:!0,configurable:!0,writable:!0,value:64}),Object.defineProperty(this,"encSize",{enumerable:!0,configurable:!0,writable:!0,value:56}),Object.defineProperty(this,"publicKeySize",{enumerable:!0,configurable:!0,writable:!0,value:56}),Object.defineProperty(this,"privateKeySize",{enumerable:!0,configurable:!0,writable:!0,value:56})}};export{K as AeadId,se as Aes128Gcm,Ie as Aes256Gcm,je as CipherSuite,R as DecapError,k as DeriveKeyPairError,h as DeserializeError,He as DhkemP256HkdfSha256,Ue as DhkemP384HkdfSha384,Be as DhkemP521HkdfSha512,Ne as DhkemX25519HkdfSha256,Ce as DhkemX448HkdfSha512,G as EncapError,F as ExportError,Le as ExportOnly,ze as HkdfSha256,Te as HkdfSha384,De as HkdfSha512,p as HpkeError,f as InvalidParamError,L as KdfId,c as KemId,W as MessageLimitReachedError,b as NotSupportedError,X as OpenError,$ as SealError,d as SerializeError,_e as ValidationError};
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */
